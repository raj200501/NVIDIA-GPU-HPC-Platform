const http = require('http');
const { parse: parseUrl } = require('url');

function createApp() {
  const routes = [];
  const middlewares = [];

  function enhanceRes(res) {
    res.status = function status(code) {
      res.statusCode = code;
      return res;
    };
    res.json = function json(payload) {
      res.setHeader('Content-Type', 'application/json');
      res.end(JSON.stringify(payload));
    };
    res.send = function send(payload) {
      if (typeof payload === 'object') {
        res.setHeader('Content-Type', 'application/json');
        res.end(JSON.stringify(payload));
      } else {
        res.end(payload);
      }
    };
  }

  function addRoute(method, path, handler) {
    const { matcher, keys } = compilePath(path);
    routes.push({ method, matcher, keys, handler });
  }

  function handler(req, res) {
    enhanceRes(res);
    let idx = 0;
    const originalUrl = req.url;

    function runMiddleware() {
      if (idx >= middlewares.length) {
        return runRoutes();
      }
      const current = middlewares[idx++];
      if (current.path) {
        if (!req.url.startsWith(current.path)) {
          return runMiddleware();
        }
        const previousUrl = req.url;
        req.url = req.url.slice(current.path.length) || '/';
        current.fn(req, res, () => {
          req.url = previousUrl;
          runMiddleware();
        });
      } else {
        current.fn(req, res, runMiddleware);
      }
    }

    function runRoutes() {
      const { pathname } = parseUrl(req.url, true);
      const method = req.method.toUpperCase();
      for (const route of routes) {
        if (route.method !== method) continue;
        const match = route.matcher.exec(pathname);
        if (match) {
          req.params = {};
          route.keys.forEach((key, i) => {
            req.params[key] = match[i + 1];
          });
          return route.handler(req, res);
        }
      }
      res.statusCode = 404;
      res.end('Not Found');
    }

    runMiddleware();
  }

  handler.use = function use(pathOrFn, maybeFn) {
    if (typeof pathOrFn === 'string') {
      middlewares.push({ path: pathOrFn, fn: maybeFn });
    } else {
      middlewares.push({ path: null, fn: pathOrFn });
    }
  };

  handler.get = (path, fn) => addRoute('GET', path, fn);
  handler.post = (path, fn) => addRoute('POST', path, fn);
  handler.put = (path, fn) => addRoute('PUT', path, fn);
  handler.delete = (path, fn) => addRoute('DELETE', path, fn);
  handler.listen = (port, cb) => {
    const server = http.createServer(handler);
    return server.listen(port, cb);
  };

  return handler;
}

function compilePath(path) {
  const segments = path.split('/').filter(Boolean);
  const keys = [];
  const parts = segments.map((segment) => {
    if (segment.startsWith(':')) {
      keys.push(segment.slice(1));
      return '([^/]+)';
    }
    return segment.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  });
  const regex = new RegExp('^/' + parts.join('/') + '/?$');
  return { matcher: regex, keys };
}

function Router() {
  const router = createApp();
  router.isRouter = true;
  return router;
}

function json() {
  return function jsonMiddleware(req, res, next) {
    let body = '';
    req.on('data', (chunk) => {
      body += chunk;
    });
    req.on('end', () => {
      if (body.length > 0) {
        try {
          req.body = JSON.parse(body);
        } catch (err) {
          req.body = {};
        }
      } else {
        req.body = {};
      }
      next();
    });
  };
}

const express = Object.assign(createApp, { Router, json });
module.exports = express;
